<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="runbot.bundle">
            <t t-call='runbot.base_layout'>
                <div class="container-fluid">
                    <div class="row">
                        <div class='col-md-12'>
                            <div class="navbar navbar-default">
                                <span class="text-center" style="font-size: 18px;">
                                    <t t-esc="bundle.name"/>
                                    <i t-if="bundle.sticky" class="fa fa-star" style="color: #f0ad4e" />
                                    <div class="btn-group  btn-group-sm" role="group">
                                        <a groups="runbot.group_runbot_admin" t-attf-href="/web/#id={{bundle.id}}&amp;view_type=form&amp;model=runbot.bundle" class="btn btn-default" target="new" title="View in Backend">
                                          <i class="fa fa-list"/>
                                        </a>
                                        <a class="btn btn-default" groups="base.group_user" t-attf-href="/runbot/bundle/{{bundle.id}}/force" title="Force A New Batch">
                                            <i class="fa fa-refresh"/>
                                        </a>
                                        <a class="btn btn-default" groups="base.group_user" t-attf-href="/runbot/bundle/{{bundle.id}}/force/1" title="Force A New Batch with automatic rebase">
                                            <i class="fa fa-fast-forward"/>
                                        </a>
                                        <t t-call="runbot.branch_copy_button"/>
                                        <t t-call="runbot.bundle_stats_dropdown"/>
                                    </div>
                                </span>
                                <span class="pull-right">
                                    <t t-call="website.pager" />
                                </span>
                            </div>
                            <div>
                                <table class="table table-condensed table-responsive table-stripped">
                                    <tr>
                                        <td>Version</td>
                                        <td>
                                            <t t-esc="bundle.version_id.name"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Branches</td>
                                        <td>
                                            <t t-foreach="bundle.branch_groups().items()" t-as="group">
                                                <t t-foreach="group[1]" t-as="branch">
                                                    <small>
                                                        <div class="btn-toolbar mb-1" role="toolbar">
                                                            <div class="btn-group btn-group-ssm" role="group">
                                                                <a t-att-href="branch.branch_url" class="btn btn-default text-left" title="View Branch on Github"><i class="fa fa-github"/></a>
                                                                <a groups="runbot.group_runbot_admin" class="btn btn-default fa fa-list text-left" t-attf-href="/web/#id={{branch.id}}&amp;view_type=form&amp;model=runbot.branch" target="new" title="View Branch in Backend"/>
                                                                <a href="#" t-esc="branch.remote_id.short_name" class="btn btn-default disabled text-left"/>
                                                                <a t-attf-href="/runbot/branch/{{branch.id}}" class="btn btn-default text-left" title="View Branch Details"><t t-esc="branch.name"/> <i t-if="not branch.alive" title="deleted/closed" class="fa fa-ban text-danger"/></a>
                                                                <t t-if="len(group[1]) == 1 and not branch.is_pr">
                                                                    <a t-attf-href="https://{{group[0].main_remote_id.base_url}}/compare/{{bundle.version_id.name}}...{{branch.remote_id.owner}}:{{branch.name}}?expand=1" class="btn btn-default text-left" title="Create pr"><i class="fa fa-code-fork"/> Create pr</a>
                                                                </t>
                                                            </div>
                                                        </div>
                                                    </small>
                                                </t>
                                            </t>
                                        </td>
                                    </tr>

                                    <tr t-if="more">
                                        <td>Project</td>
                                        <td t-esc="bundle.project_id.name"/>
                                    </tr>
                                    <tr t-if="more">
                                        <td>New build enabled</td>
                                        <td>
                                            <i t-attf-class="fa fa-{{'times' if bundle.no_build else 'check'}}"/>
                                        </td>
                                    </tr>
                                    <tr t-if="more">
                                        <td>Modules</td>
                                        <td t-esc="bundle.modules or '/'"/>
                                    </tr>
                                </table>
                            </div>
                            <div t-foreach="bundle.consistency_warning()" t-as="warning" t-esc="warning[1]" t-attf-class="alert alert-{{warning[0]}}"/>
                            <div class="batch_row" t-foreach="batchs" t-as="batch">
                                <t t-call="runbot.batch_tile"/>
                            </div>
                        </div>
                    </div>
                </div>
            </t>
        </template>


        <template id="runbot.batch_tile">
        <t t-set="klass">info</t>
        <t t-if="batch.state=='skipped'" t-set="klass">killed</t>
        <t t-if="batch.state=='done' and all(slot.build_id.global_result == 'ok' for slot in batch.slot_ids if slot.build_id)" t-set="klass">success</t>
        <t t-if="batch.state=='done' and any(slot.build_id.global_result in ('ko', 'warn') for slot in batch.slot_ids)" t-set="klass">danger</t>

        <div t-attf-class="batch_tile {{'more' if more else 'nomore'}}">
            <div t-attf-class="card bg-{{klass}}-light">
            <div class="batch_header">
                <a t-attf-href="/runbot/batch/#{batch.id}" t-attf-class="badge badge-{{'warning' if batch.has_warning else 'light'}}" title="View Batch">
                <t t-esc="batch.get_formated_age()"/>
                <i class="fa fa-exclamation-triangle" t-if="batch.has_warning"/>
                <i class="arrow fa fa-window-maximize"/>
                </a>
            </div>
            <t t-if="batch.state=='preparing'">
                <span><i class="fa fa-cog fa-spin fa-fw"/> preparing</span>
            </t>
            <div class="batch_slots">
                <t t-foreach="batch.slot_ids" t-as="slot">
                <t t-if="slot.build_id">
                    <div t-if="not slot.trigger_id.manual and ((not slot.trigger_id.hide and trigger_display is None) or (trigger_display and slot.trigger_id.id in trigger_display))"
                    t-call="runbot.slot_button" class="slot_container"/>
                </t>
                </t>
                <div class="slot_filler" t-foreach="range(10)" t-as="x"/>
            </div>
            <div class="batch_commits">
                <div t-foreach="batch.commit_link_ids.sorted(lambda cl: (cl.commit_id.repo_id.sequence, cl.commit_id.repo_id.id))" t-as="commit_link" class="one_line">

                <a t-attf-href="/runbot/commit/#{commit_link.commit_id.id}" t-attf-class="badge badge-light batch_commit match_type_{{commit_link.match_type}}">
                    <i class="fa fa-fw fa-hashtag" t-if="commit_link.match_type == 'new'" title="This commit is a new head"/>
                    <i class="fa fa-fw fa-link" t-if="commit_link.match_type == 'head'" title="This commit is an existing head from bundle branches"/>
                    <i class="fa fa-fw fa-code-fork" t-if="commit_link.match_type == 'base_match'" title="This commit is matched from a base batch with matching merge_base"/>
                    <i class="fa fa-fw fa-clock-o" t-if="commit_link.match_type == 'base_head'" title="This commit is the head of a base branch"/>
                    <t t-esc="commit_link.commit_id.dname"/>
                </a>
                <a t-att-href="'https://%s/commit/%s' % (commit_link.branch_id.remote_id.base_url, commit_link.commit_id.name)" class="badge badge-light" title="View Commit on Github"><i class="fa fa-github"/></a>
                <span t-esc="commit_link.commit_id.subject"/>
                </div>
            </div>
            </div>
        </div>
        </template>
    </data>
</odoo>
